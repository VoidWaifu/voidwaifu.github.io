<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoidWaifu - Блог</title>
    <link rel="stylesheet" href="../css/blogpage.css">
    <link rel="icon" type="image/png" href="../assets/icon.png">
</head>

<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../">VoidWaifu</a>
                </div>
                <div class="menu-toggle" id="menuToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <nav id="mainNav">
                    <ul>
                        <li><a href="../">Главная</a></li>
                        <li><a href="../blog/">Блог</a></li>
                        <li><a href="../projects/">Другие проекты</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="blog-controls">
                <div class="sort-controls">
                    <button id="sort-button">Сначала новые</button>
                </div>
                <div class="search-controls">
                    <input type="text" id="search-input" placeholder="Поиск...">
                </div>
            </div>
            <div class="posts-grid" id="posts-container">
            </div>
            <div class="loading-spinner" id="loading-spinner">
                <div class="spinner"></div>
            </div>
        </div>
    </main>

    <script src="list.js"></script>
    <script>
        let currentSortOrder = 'newest';
        let currentSearchQuery = '';

        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function highlightText(text, query) {
            if (!query) return text;
            
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<mark class="search-highlight">$1</mark>');
        }

        function createPostElement(post) {
            const postElement = document.createElement('a');
            postElement.href = `../blog/post/${post.id}/`;
            postElement.className = 'post-card hidden';
            
            let title = post.title;
            let description = post.description;
            
            if (currentSearchQuery) {
                title = highlightText(title, currentSearchQuery);
                description = highlightText(description, currentSearchQuery);
            }
            
            postElement.innerHTML = `
                <h3 class="post-title">${title}</h3>
                <p class="post-description">${description}</p>
                <div class="post-date">${formatDate(post.id)}</div>
            `;
            
            return postElement;
        }

        function filterPosts(posts, query) {
            if (!query) return posts;
            
            const lowerQuery = query.toLowerCase();
            return posts.filter(post => 
                post.title.toLowerCase().includes(lowerQuery) || 
                post.description.toLowerCase().includes(lowerQuery)
            );
        }

        function sortPosts(posts, order) {
            return [...posts].sort((a, b) => {
                if (order === 'newest') {
                    return b.id - a.id;
                } else {
                    return a.id - b.id;
                }
            });
        }

        function renderPosts() {
            const container = document.getElementById('posts-container');
            container.innerHTML = '';
            
            const filteredPosts = filterPosts(posts, currentSearchQuery);
            const sortedPosts = sortPosts(filteredPosts, currentSortOrder);
            
            sortedPosts.forEach(post => {
                const postElement = createPostElement(post);
                container.appendChild(postElement);
            });
            
            initScrollAnimation();
        }

        function loadPosts() {
            const spinner = document.getElementById('loading-spinner');
            
            spinner.style.display = 'flex';
            
            setTimeout(() => {
                renderPosts();
                spinner.style.display = 'none';
            }, 500);
        }

        function initScrollAnimation() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.post-card.hidden').forEach(card => {
                observer.observe(card);
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const menuToggle = document.getElementById('menuToggle');
        const mainNav = document.getElementById('mainNav');

        if (menuToggle && mainNav) {
            menuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                mainNav.classList.toggle('active');
                menuToggle.classList.toggle('active');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.header-content')) {
                    mainNav.classList.remove('active');
                    menuToggle.classList.remove('active');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPosts();
            
            const sortButton = document.getElementById('sort-button');
            sortButton.addEventListener('click', () => {
                currentSortOrder = currentSortOrder === 'newest' ? 'oldest' : 'newest';
                sortButton.textContent = currentSortOrder === 'newest' ? 'Сначала новые' : 'Сначала старые';
                renderPosts();
            });

            const searchInput = document.getElementById('search-input');
            const debouncedSearch = debounce(() => {
                currentSearchQuery = searchInput.value.trim();
                renderPosts();
            }, 300);

            searchInput.addEventListener('input', debouncedSearch);
        });
    </script>
</body>
</html>
